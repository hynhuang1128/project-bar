#### 健康数据发送

##### 实现逻辑

- 实现健康数据的发送需要两个过程：

  - 芯片端健康数据的存储。
  - 芯片端健康数据的发送。

  下面将详细讲解以下两个问题。

##### 芯片端健康数据的存储：

- 说明：

  - 健康数据的本质是用户姿态改变时所得到的当前用户姿态及当时的时间戳数据。
  - 在存储健康数据时，需要得到两个数据：
    - 用户姿态
    - 时间戳数据
  - 需要获得这两个数据的时间应在：在用户姿态发生改变时。

- 具体实现逻辑：

  - 数据结构：

    一个结构体类型的数据，其中包括：

    - 用户姿态改变时的用户姿态
    - 用户姿态改变时的上电时间戳

    该数据一共201组，以队列的方式存储。如果没有达到最大组数（201组）则将新的数据顺序存储；如果已经达到最大组数（201组）则将新的数据存入队列尾部，并将头部数据销毁。

  - 实现逻辑流程图：

    *（注：每1000ms执行一次该动作）*

    ![health data](C:\Users\Zeuse-hyn\Downloads\health data (1).png)

  - 总结：

    - 当且仅当在用户数据发生改变时，往健康数据队列中存入数据。
    - 超过队列最大限制时，会将最先存储进入的数据清除。

### 芯片端健康数据发送：

- 说明：
  - 在接收到手机端的“发送健康数据”指令时，以30ms为周期，将健康数据队列从队头至队尾依次发送。
  - 健康数据以16字节为一组向手机端发送，其中第1个字节为发送的包计数；而其它的15个字节中每一组数据包含3个小组数据，每一个小组数据包含1个字节的用户姿态以及4个字节的当前时间戳。
- 具体实现逻辑：
  - 在收到“发送健康数据”指令时，将当前的数据队列通过分包的方式，并将其分入到缓冲区内。
  - 在数据每一次进行分包时，包计数+1。
  - 完成一次分包之后，则立即将该数据（包计数+3小组数据）发送到手机端。
  - 以上功能以30ms为周期循环执行，直到，包计数大于最大数据组数时结束该周期循环。